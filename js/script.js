const COURSE_TREE = [
  {
    title: "üìÇ Âü∫Á§éÂÖ•ÈñÄ",
    chapters: [
      { href: "hello_world.html", title: "Hello, World!", desc: "‰Ω†ÁöÑÁ¨¨‰∏ÄÂÄã Python Á®ãÂºèÔºåË™çË≠òÁ®ãÂºèÁöÑÂü∑Ë°åÊµÅÁ®ã„ÄÇ" },
      { href: "variables_data_types.html", title: "ËÆäÊï∏ËàáË≥áÊñôÂûãÊÖã", desc: "‰∫ÜËß£Ë≥áÊñôÂ¶Ç‰ΩïÂëΩÂêç„ÄÅÂÑ≤Â≠òËàáÂàÜÈ°û„ÄÇ" },
      { href: "input.html", title: "input ÂáΩÊï∏", desc: "ËÆìÁ®ãÂºèËÉΩËàá‰ΩøÁî®ËÄÖ‰∫íÂãïÔºåËÆÄÂèñËº∏ÂÖ•Ë≥áÊñô„ÄÇ" },
      { href: "arithmetic_operators.html", title: "ÁÆóË°ìÈÅãÁÆóÁ¨¶ËôüËàáÈÅãÁÆóÂÑ™ÂÖàÈ†ÜÂ∫è", desc: "Êï∏Â≠∏ÈÅãÁÆóËàáÈÅãÁÆóÈ†ÜÂ∫èÁöÑÂü∫Êú¨Ë¶èÂâá„ÄÇ" },
      { href: "print.html", title: "print ÈÄ≤Èöé", desc: "Êõ¥ÈùàÊ¥ªÂú∞Ëº∏Âá∫Ë≥áË®äÂà∞Ëû¢Âπï„ÄÇ" },
      { href: "string_format.html", title: "Â≠ó‰∏≤Ê†ºÂºèÂåñ", desc: "Â∞áËÆäÊï∏ÊàñË≥áÊñôÊºÇ‰∫ÆÂú∞ÂµåÂÖ•ÊñáÂ≠ó‰∏≠„ÄÇ" }
    ]
  },
  {
    title: "üìÇ ÈÇèËºØËàáÊµÅÁ®ãÊéßÂà∂",
    chapters: [
      { href: "logical_operators.html", title: "ÈÇèËºØËàáÊØîËºÉÈÅãÁÆóÁ¨¶Ëôü", desc: "Âà§Êñ∑Ê¢ù‰ª∂ÁúüÊàñÂÅáÁöÑÂü∫Êú¨Â∑•ÂÖ∑„ÄÇ" },
      { href: "if.html", title: "Ê¢ù‰ª∂Âà§Êñ∑", desc: "ËÆìÁ®ãÂºè‰æù‰∏çÂêåÊ¢ù‰ª∂ÈÅ∏ÊìáÊÄßÂü∑Ë°å„ÄÇ" },
      { href: "loop.html", title: "Ëø¥Âúà", desc: "ÈáçË§áÂü∑Ë°åÁ®ãÂºèÁ¢ºÔºåÊèêÈ´òÊïàÁéá„ÄÇ" },
      { href: "def.html", title: "Ëá™Ë®ÇÂáΩÂºè", desc: "Â∞áÁ®ãÂºèÊ®°ÁµÑÂåñ‰∏¶ÈáçË§á‰ΩøÁî®„ÄÇ" }
    ]
  },
  {
    title: "üìÇ ÂïèÈ°åÂ∞éÂêëÁ∑¥ÁøíÔºàÈöéÊÆµ‰∏ÄÔºâ",
    chapters: [
      { href: "practice_1.html", title: "ÂïèÈ°åÂ∞éÂêëÁ∑¥ÁøíÈ°åÁµÑ 1", desc: "ÈûèÂõ∫Âü∫Á§éË™ûÊ≥ïËàáÊµÅÁ®ãÊéßÂà∂Ê¶ÇÂøµ„ÄÇ" }
    ]
  },
  {
    title: "üìÇ ËÆäÊï∏ÁØÑÁñáËàáÈô§ÈåØ",
    chapters: [
      { href: "scope.html", title: "ÂçÄÂüüËÆäÊï∏ËàáÂÖ®ÂüüËÆäÊï∏", desc: "ÁêÜËß£ËÆäÊï∏ÁöÑ‰ΩúÁî®ÁØÑÂúçËàá‰ΩøÁî®ÊñπÂºè„ÄÇ" },
      { href: "exception.html", title: "‰æãÂ§ñËôïÁêÜ", desc: "ËôïÁêÜÈåØË™§ÔºåÈÅøÂÖçÁ®ãÂºèÂ¥©ÊΩ∞„ÄÇ" },
      { href: "debug.html", title: "ËøΩËπ§ËàáÂÅµÈåØ", desc: "ÊâæÂá∫Á®ãÂºèÈåØË™§‰∏¶‰øÆÊ≠£ÂïèÈ°å„ÄÇ" }
    ]
  },
  {
    title: "üìÇ Ë≥áÊñôÁµêÊßãÔºàÂÆπÂô®Ôºâ",
    chapters: [
      { href: "list.html", title: "‰∏≤ÂàóÂÆπÂô®", desc: "ÂÑ≤Â≠òÊúâÈ†ÜÂ∫èÁöÑ‰∏ÄÁµÑË≥áÊñôÔºåÂèØ‰øÆÊîπ„ÄÇ" },
      { href: "tuple.html", title: "ÂÖÉÁµÑÂÆπÂô®", desc: "‰∏çÂèØ‰øÆÊîπÁöÑË≥áÊñôÈõÜÂêàÔºåÈÅ©ÂêàÂõ∫ÂÆöË≥áÊñô„ÄÇ" },
      { href: "set.html", title: "ÈõÜÂêàÂÆπÂô®", desc: "‰∏çÈáçË§á‰∏îÁÑ°È†ÜÂ∫èÁöÑË≥áÊñôÈõÜÂêà„ÄÇ" },
      { href: "dict.html", title: "Â≠óÂÖ∏ÂÆπÂô®", desc: "‰ΩøÁî®ÈçµÂÄºÂ∞çÁÆ°ÁêÜË≥áÊñô„ÄÇ" }
    ]
  },
  {
    title: "üìÇ ÂïèÈ°åÂ∞éÂêëÁ∑¥ÁøíÔºàÈöéÊÆµ‰∫åÔºâ",
    chapters: [
      { href: "practice_2.html", title: "ÂïèÈ°åÂ∞éÂêëÁ∑¥ÁøíÈ°åÁµÑ 2", desc: "ÈûèÂõ∫Ë≥áÊñôÁµêÊßãËàáÁ®ãÂºèÈô§ÈåØÊäÄËÉΩ„ÄÇ" }
    ]
  },
  {
    title: "üìÇ ÈÄ≤ÈöéË™ûÊ≥ïËàáË≥áÊñôÊìç‰Ωú",
    chapters: [
      { href: "ds_functions.html", title: "ÂõõÂ§ßË≥áÊñôÁµêÊßãÂª∫ÊßãÂºè", desc: "Âø´ÈÄüÂª∫Á´ã‰∏≤Âàó„ÄÅÂÖÉÁµÑ„ÄÅÈõÜÂêàËàáÂ≠óÂÖ∏„ÄÇ" },
      { href: "packing.html", title: "ÊåáÂÆö„ÄÅÂ§öÈáçÊåáÂÆö„ÄÅÊâìÂåÖËàáËß£ÂåÖ", desc: "‰∏ÄÊ¨°ËôïÁêÜÂ§öÂÄãËÆäÊï∏ÔºåÊñπ‰æøÂáΩÂºèÂÇ≥ÂèÉ„ÄÇ" },
      { href: "in_is.html", title: "Ë∫´ÂàÜËàáÊàêÂì°ÈÅãÁÆóÁ¨¶Ëôü", desc: "Âà§Êñ∑Áâ©‰ª∂ÊòØÂê¶Áõ∏ÂêåÊàñÂ≠òÂú®ÊñºÈõÜÂêà‰∏≠„ÄÇ" },
      { href: "string_functions_methods.html", title: "Â≠ó‰∏≤ÊñπÊ≥ïËàáÂáΩÂºè", desc: "Êìç‰ΩúÂ≠ó‰∏≤„ÄÅÂàÜÊûêËàáËΩâÊèõË≥áÊñô„ÄÇ" },
      { href: "slicing.html", title: "ÂàáÁâá", desc: "ÂèñÂá∫Ë≥áÊñôÁöÑ‰∏ÄÈÉ®ÂàÜÔºåÊîØÊè¥Â≠ó‰∏≤ËàáÂÆπÂô®„ÄÇ" }
    ]
  },
  {
    title: "üìÇ Ê™îÊ°àËàáÊ®°ÁµÑ",
    chapters: [
      { href: "file.html", title: "Ê™îÊ°àÊìç‰Ωú", desc: "ËÆÄÂèñËàáÂØ´ÂÖ•Â§ñÈÉ®Ë≥áÊñôÊ™îÊ°à„ÄÇ" },
      { href: "import.html", title: "ÂåØÂÖ•Ê®°ÁµÑ", desc: "‰ΩøÁî®ÁèæÊàêÊàñËá™Ë®ÇÂäüËÉΩÊ®°ÁµÑ„ÄÇ" },
      { href: "main.html", title: "‰∫ÜËß£ __name__", desc: "ÁêÜËß£Ê®°ÁµÑÂü∑Ë°åÊñπÂºèËàá‰∏ªÁ®ãÂºèÊ¶ÇÂøµ„ÄÇ" }
    ]
  },
  {
    title: "üìÇ Áâ©‰ª∂Â∞éÂêë",
    chapters: [
      { href: "oo.html", title: "È°ûÂà•ËàáÁâ©‰ª∂", desc: "‰ΩøÁî®Áâ©‰ª∂ÊñπÂºèÁµÑÁπîÁ®ãÂºèÔºåÂ≠∏Áøí OOP Ê¶ÇÂøµ„ÄÇ" }
    ]
  },
  {
    title: "üìÇ ÂïèÈ°åÂ∞éÂêëÁ∑¥ÁøíÔºàÈöéÊÆµ‰∏âÔºâ",
    chapters: [
      { href: "practice_3.html", title: "ÂïèÈ°åÂ∞éÂêëÁ∑¥ÁøíÈ°åÁµÑ 3", desc: "Á∂úÂêàÈÅãÁî®ÂêÑÈöéÊÆµÊâÄÂ≠∏Áü•Ë≠ò„ÄÇ" }
    ]
  },
  {
    title: "üìÇ Á∂úÂêàÂØ¶‰ΩúÂ∞àÈ°å",
    chapters: [
      { href: "practice_stock_price.html", title: "ÊäìÂèñ TSMC ËÇ°Á•®Ê≠∑Âè≤ÂÉπÊ†º", desc: "ÂØ¶ÂãôË≥áÊñôÂàÜÊûêÂÖ•ÈñÄÔºå‰ΩøÁî® Python Êì∑ÂèñË≥áÊñô„ÄÇ" },
      { href: "practice_pygame_zero.html", title: "Pygame Zero Âü∫Á§éÊïôÂ≠∏", desc: "Áî® Python Ë£Ω‰Ωú‰∫íÂãïÈÅäÊà≤ÔºåÂÖ•ÈñÄÈÅäÊà≤Ë®≠Ë®à„ÄÇ" },
      { href: "practice_optical_illusions_pgzero.html", title: "Hering Illusion", desc: "Á®ãÂºèÂØ¶‰ΩúË¶ñË¶∫ÈåØË¶∫ÊïàÊûúÔºåÂ≠∏ÁøíÂãïÁï´ÊéßÂà∂„ÄÇ" },
      { href: "practice_stroop_pgzero.html", title: "Stroop Task", desc: "ÂøÉÁêÜÂØ¶È©óÁ®ãÂºèÂØ¶‰ΩúÔºåÁêÜËß£Âà∫ÊøÄËàáÂèçÊáâ„ÄÇ" },
      { href: "practice_bouncing_balls_pgzero.html", title: "Bouncing Balls", desc: "ÂãïÁï´ËàáÁâ©ÁêÜÊ¶ÇÂøµÊï¥ÂêàÔºåÊ®°Êì¨ÂΩàË∑≥ÊïàÊûú„ÄÇ" }
    ]
  }
];

// Helper updated to use class-based logic via your backend or Firestore auth state
// Change: Add userData as a parameter
async function getDocVisibility(userData) {
    try {
        if (!userData || !userData.studentClass) {
            console.warn("No student class found for this user.");
            return {};
        }

        const studentClass = userData.studentClass;

        // Fetch the global visibility settings
        const docSnap = await db.collection("system").doc("docs").get();
        if (!docSnap.exists) return {};
        
        const docs = docSnap.data().documents || [];
        
        return docs.reduce((acc, d) => {
            const fileName = d.url.split('/').pop();
            const allowedClasses = d.visible_classes || [];
            
            // Logic: Is the student's class in the allowed list?
            acc[fileName] = allowedClasses.includes(studentClass);
            return acc;
        }, {});
    } catch (e) {
        console.error("Visibility Error:", e);
        return {};
    }
}

// includeHTML and includeHomeNav remain largely the same, 
// as they simply consume the map returned by getDocVisibility()
// Change: accept visibilityMap as an argument
async function includeHTML(visibilityMap = null) {
    const navContainer = document.querySelector("[w3-include-html]");
    if (!navContainer) return;

    // IF NO DATA YET: Show spinner and stop here
    if (visibilityMap === null) {
        navContainer.innerHTML = `
            <div class="p-4 text-slate-400 text-sm flex items-center gap-2">
                <span class="spinner"></span> Ê≠£Âú®ËºâÂÖ•ÈÅ∏ÂñÆ...
            </div>`;
        return; 
    }

    // IF DATA ARRIVED: Build the actual menu
    let html = `<ul class="nav flex-column">
        <li><a href="index.html" class="home-link">ÂõûÂà∞È¶ñÈ†Å</a></li>`;

    COURSE_TREE.forEach(group => {
        html += `<li class="nav-item"><details open><summary>${group.title}</summary><ul>`;
        group.chapters.forEach(ch => {
            const isVisible = visibilityMap[ch.href] !== false;
            html += `
                <li class="${isVisible ? '' : 'nav-locked'}">
                    <a href="${isVisible ? ch.href : 'javascript:void(0)'}">
                        ${ch.title} ${isVisible ? '' : 'üîí'}
                    </a>
                </li>`;
        });
        html += `</ul></details></li>`;
    });

    navContainer.innerHTML = html;
    
	highlightItem();
}

async function includeHomeNav(visibilityMap = null) {
    const container = document.getElementById("home-navigation");
    if (!container) return;

    // --- STEP 1: IMMEDIATE SKELETON STATE ---
    // If no data yet, show the shimmer effect and exit the function
    if (visibilityMap === null) {
        container.innerHTML = `
            <div class="course-map">
                <section class="course-group loading-skeleton">
                    <div class="skeleton-title"></div>
                    <div class="card-grid">
                        ${Array(3).fill('<div class="skeleton-card"></div>').join('')}
                    </div>
                </section>
            </div>`;
        return; 
    }

    // --- STEP 2: ACTUAL CONTENT RENDER ---
    // This part runs once the visibilityMap is passed from the Auth observer
    let html = `<div class="course-map">`;
    
    COURSE_TREE.forEach((group, index) => {
        html += `
            <section class="course-group" style="animation: fadeInUp 0.5s ease forwards; animation-delay: ${index * 0.1}s;">
                <h3>${group.title}</h3>
                <div class="card-grid">`;

        group.chapters.forEach(ch => {
            // Check visibility against our class-based map
            const isVisible = visibilityMap[ch.href] !== false;
            
            html += `
                <a href="${isVisible ? ch.href : 'javascript:void(0)'}" 
                   class="card ${isVisible ? '' : 'locked-card'}"
                   ${!isVisible ? 'onclick="alert(\'Ê≠§Ë™≤Á®ãÂ∞öÊú™Â∞çÊÇ®ÁöÑÁè≠Á¥öÈñãÊîæ\')"' : ''}>
                    <h4>${ch.title} ${isVisible ? '' : 'üîí'}</h4>
                    <p>${ch.desc}</p>
                </a>`;
        });
        
        html += `</div></section>`;
    });

    html += `</div>`;
    container.innerHTML = html;
}

/*
function includeHTML(cb=null) {
  var z, i, elmnt, file, xhttp;
  
  z = document.getElementsByTagName("*");
  for (i = 0; i < z.length; i++) {
    elmnt = z[i];
    
    file = elmnt.getAttribute("w3-include-html");
    if (file) {      
      xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
			if (this.status == 200) {
				elmnt.innerHTML = this.responseText;	
				if (cb) cb();
			}
			if (this.status == 404) {
				elmnt.innerHTML = "Page not found.";
			}
          
          elmnt.removeAttribute("w3-include-html");
          includeHTML();
        }
      }
      xhttp.open("GET", file, true);
      xhttp.send();
      
      return;
    }
  }
}
*/

/* ========= TREE NAV BEHAVIOR ========= */

// track whether Ctrl is held
let ctrlPressed = false;
document.addEventListener('keydown', e => { if (e.ctrlKey) ctrlPressed = true; });
document.addEventListener('keyup',   e => { ctrlPressed = false; });

function highlightItem() {
  const currentPage = window.location.pathname.split('/').pop();

  document.querySelectorAll('.nav a[href]').forEach(link => {
    if (link.getAttribute('href') === currentPage) {
      link.classList.add('active');

      const details = link.closest('details');
      if (details) {
        // collapse others unless Ctrl is pressed
        if (!ctrlPressed) {
          document.querySelectorAll('.nav details').forEach(d => {
            if (d !== details) d.open = false;
          });
        }

        details.open = true;

        const summary = details.querySelector('summary');
        if (summary) summary.classList.add('active-group');
      }

      link.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  });

  // copy buttons (guarded)
  document.querySelectorAll('pre code').forEach(block => {
    if (block.parentNode.querySelector('.copy-btn')) return;

    const btn = document.createElement('button');
    btn.textContent = 'Copy';
    btn.className = 'btn btn-sm btn-secondary copy-btn';

    const pre = block.parentNode;
    pre.style.position = 'relative';
    btn.style.position = 'absolute';
    btn.style.top = '6px';
    btn.style.right = '6px';
    pre.appendChild(btn);

    btn.addEventListener('click', () => {
      navigator.clipboard.writeText(block.textContent).then(() => {
        btn.textContent = 'Copied!';
        setTimeout(() => (btn.textContent = 'Copy'), 1500);
      });
    });
  });
}

// auto-collapse logic on clicking group titles
document.addEventListener('click', e => {
  const summary = e.target.closest('summary');
  if (!summary) return;

  if (!ctrlPressed) {
    document.querySelectorAll('.nav details').forEach(d => {
      if (d !== summary.parentElement) d.open = false;
    });
  }
});


function navClick() {
	const sidebar = document.getElementById("sidebar");
	const main = document.querySelector("main");
	const header = document.querySelector("main > header");
	const toggleButton = document.getElementById("toggleNav");
	
	if (sidebar.classList.contains("hidden")) {
		sidebar.classList.remove("hidden");
		toggleButton.style.left = "205px"; // Sidebar width
		main.style.marginLeft = "0"; // Nudge main content
		header.style.paddingLeft = "250px"; // Restore header content
        main.style.width = "calc(100% - 190px)"; // Adjust width
		toggleButton.innerHTML = "&#8212;"; // Single line
	} else {
		sidebar.classList.add("hidden");
		toggleButton.style.left = "0"; // Align with the left border of the page
		main.style.marginLeft = "-250px"; // Restore main content
		header.style.paddingLeft = "0"; // Nudge header content
        main.style.width = "100%"; // Reset width
		toggleButton.innerHTML = "&#9776;"; // Three lines (hamburger icon)
	}
}

/*
function enableAnswerRevealer() {	
	const urlParams = new URLSearchParams(window.location.search);
	const overrideKey = parseInt(urlParams.get("override"));
	const fileName = window.location.pathname.split('/').pop();
	const GOOGLE_SHEETS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSF-MJYb-3c-teT8X6Te8eqIoP4UC8BsgMUI0pcpo2VYKrf178ACOjLEfuFpuRPu3QSy5DDk2KY1jTO/pub?gid=0&single=true&output=csv";
	
    let isOverrideActive = false; // Flag to determine if the global override is active

	fetch(GOOGLE_SHEETS_CSV_URL)
		.then(response => response.text()) // Read CSV as text
		.then(data => {
			let rows = data.split("\n"); // Split CSV rows		
			const result = {};

			rows.forEach(row => {
				const [key, ...values] = row.split(","); // Split by comma
				result[key.trim()] = values.map(value => value.trim())
								.filter(value => value !== "")
								.map(Number);
			});
			
			console.log("Parsed CSV Data:", result); // Updated log for clarity
			
            // 1. Determine if the global override is active
            if (result["reveal"] && overrideKey && result["reveal"].includes(overrideKey)) {
                isOverrideActive = true;
                console.log("Global Answer Override is Active.");
            }
			
			console.log(result["reveal"], overrideKey);
            
            // 2. Get the list of problems to reveal on this specific page
            const revealedProblems = result[fileName] || []; 
			
            // Use revealedProblems and isOverrideActive to determine visibility
			document.querySelectorAll('.caption .icon').forEach((icon, index) => {
				const problemIndex = index + 1; // 1-based index
                
                // Condition to HIDE the answer/icon:
                // Hide if: 
                // a) The global override is NOT active, AND
                // b) The problem's index is NOT in the page-specific revealed list.
                const shouldHide = !isOverrideActive && !revealedProblems.includes(problemIndex);
					
				if (shouldHide) {
					icon.style.display = 'none'; // Hide the icon
					const caption = icon.closest('.caption');
					let answerElement = caption.nextElementSibling;
					while (answerElement && !answerElement.classList.contains('answer')) {
						answerElement = answerElement.nextElementSibling;
					}
					if (answerElement) {
						answerElement.style.display = 'none'; // Hide the answer
					}
				} else {
                    // Answer is visible/clickable (either via override or page-specific list)
					let clickCount = 0;
					let isAnswerVisible = false;
					const numClicksToReveal = 1;
					
					icon.addEventListener('click', function (event) {
						// Prevent bubbling to the parent `.caption` click handler
						event.stopPropagation();

						clickCount++;

						if (clickCount === numClicksToReveal) {
							// Find the parent `.caption` element
							const caption = icon.closest('.caption');

							// Find the next sibling `.answer` element
							let answerElement = caption.nextElementSibling;
							while (answerElement && !answerElement.classList.contains('answer')) {
								answerElement = answerElement.nextElementSibling;
							}

							if (answerElement) {
								if (!isAnswerVisible) {
									answerElement.style.display = 'block';
									icon.classList.add('revealed');
								} else {
									answerElement.style.display = 'none';
									icon.classList.remove('revealed');
								}

								caption.classList.toggle('active');
								isAnswerVisible = !isAnswerVisible;
							}

							// Reset the click count after toggling
							clickCount = 0;
						}
					});
				}					
			});
			
		})
		.catch(error => {
			console.error("Error fetching CSV:", error);
			
			// Default behavior on error: hide all answers
			document.querySelectorAll('.caption .icon').forEach(icon => {
				icon.style.display = 'none'; // Hide the icon
				const caption = icon.closest('.caption');
				let answerElement = caption.nextElementSibling;
				while (answerElement && !answerElement.classList.contains('answer')) {
					answerElement = answerElement.nextElementSibling;
				}
				if (answerElement) {
					answerElement.style.display = 'none'; // Hide the answer
				}
			});
		});
}
*/